from telethon import TelegramClient, sync, types
from fuzzywuzzy import fuzz
import datetime
import re
import os
from datetime import datetime, timedelta, timezone
import time

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
api_id = '27868015'
api_hash = '463c9ad66cd28373687dae5ccf7b0d6b'
phone_number = '+93728558690'

# Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø¨Ø¹ Ùˆ Ú©Ø§Ù†Ø§Ù„ Ù…Ù‚ØµØ¯
source_channels = ['@HeratTimess', '@Newsof_Herat', '@tamadontv']
destination_channel = '@AFGTNews'

# Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø­Ø°Ù Ø´ÙˆÙ†Ø¯
remove_channels = ['@HeratTimess | Ù‡Ø±Ø§Øª ØªØ§ÛŒÙ…Ø²', '@Newsof_Herat ðŸ‘ˆØ®Ø¨Ø±Ø¢Ù†Ù„Ø§ÛŒÙ† Ù‡Ø±Ø§Øª', '@tamadontv']

# Ù„ÛŒØ³Øª Ø¹Ø¨Ø§Ø±Ø§Øª ÛŒØ§ Ú©Ù„Ù…Ø§ØªÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø­Ø°Ù Ø´ÙˆÙ†Ø¯
remove_phrases = ['Ù‡Ø±Ø§Øª ØªØ§ÛŒÙ…Ø²', 'Ø®Ø¨Ø±Ø¢Ù†Ù„Ø§ÛŒÙ† Ù‡Ø±Ø§Øª', 'Ù„ÛŒÙ†Ú© ÙˆØ¨â€ŒØ³Ø§ÛŒØª', 'Ø²Ù†Ø¯Ù‡ | ÙÛŒØ³Ø¨ÙˆÚ© | ÙˆØ¨â€Œ | x | ÛŒÙˆØªÛŒÙˆØ¨ | Ø¨Ø¹Ø¯Ø§Ø²Ø®Ø¨Ø± | Ú¯ÙØªØ§ÙˆØ±Ø¯', '|']

# ÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡
sent_messages_file = "sent_messages.txt"

# Ù„ÛŒÙ†Ú© Ú©Ø§Ù†Ø§Ù„ Ù…Ù‚ØµØ¯ Ø´Ù…Ø§
destination_link = "@AFGTNews"  # Ù„ÛŒÙ†Ú© Ú©Ø§Ù†Ø§Ù„ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù¾ÛŒØ§Ù…

# Ù„ÛŒØ³Øª Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ ØªØ¨Ù„ÛŒØºØ§Øª
ad_keywords = ['ØªØ¨Ù„ÛŒØº', 'Ø§Ø³Ù¾Ø§Ù†Ø³Ø±', 'Ø®Ø±ÛŒØ¯', 'Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯', 'Ø§Ø±Ø³Ø§Ù„ Ø±Ø§ÛŒÚ¯Ø§Ù†', 'ÙØ±ÙˆØ´', 'Ø´Ù…Ø§Ø±Ù‡ Ù‡Ø§ÛŒ ØªÙ…Ø§Ø³', 'ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯', 'Ø¢Ø¯Ø±Ø³', 'Ù„ÛŒÙ†Ú©', 'Ø³Ø±Ø®Ø·', 'Ù¾ÛŒØ§Ù… Ø´Ù‡Ø±ÙˆÙ†Ø¯', 'ÙˆØ§ØªØ³Ø§Ù¾', 'Ø­Ù…Ø§ÛŒØª Ú©Ù†ÛŒØ¯', 'Ù¾ÚšØªÙˆ Ø®Ø¨Ø±ÙˆÙ†Ù‡', '#Ú¯ÙØªØ§ÙˆØ±Ø¯','Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±']

# ØªØ§Ø¨Ø¹ Ú†Ú© ØªØ¨Ù„ÛŒØºØ§Øª
def is_advertisement(message):
    for keyword in ad_keywords:
        if keyword in message:
            return True
    return False

# ØªØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡
def save_sent_message(cleaned_message):
    with open(sent_messages_file, "a", encoding="utf-8") as f:
        f.write(f"{cleaned_message}\n")

# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¨ÙˆØ¯Ù† Ù¾ÛŒØ§Ù…
def is_duplicate(message_text):
    with open(sent_messages_file, "r", encoding="utf-8") as f:
        for line in f:
            if fuzz.partial_ratio(line.strip(), message_text) > 85:
                return True
    return False

# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù„ÛŒÙ†Ú©ØŒ Ù†Ø§Ù… Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ùˆ Ø¹Ø¨Ø§Ø±Ø§Øª Ø®Ø§Øµ Ø§Ø² Ù…ØªÙ† Ù¾ÛŒØ§Ù…
def clean_message_content(message_text):
    for channel in remove_channels:
        message_text = re.sub(channel, '', message_text)
    
    message_text = re.sub(r'https?://\S+|www\.\S+', '', message_text)
    
    for phrase in remove_phrases:
        message_text = message_text.replace(phrase, '')
        
    return message_text.strip()

# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¯Ø± Ù¾Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø²Ø§ Ø¨Ø§ Ø­ÙØ¸ Ù…Ø±Ø² Ú©Ù„Ù…Ø§Øª
def send_long_message(client, destination_channel, message_text):
    max_length = 1024
    parts = []
    current_part = ""

    for paragraph in message_text.split('\n'):
        if len(current_part) + len(paragraph) + 1 > max_length:
            parts.append(current_part.strip())
            current_part = ""
        
        words = paragraph.split()
        for word in words:
            if len(current_part) + len(word) + 1 > max_length:
                parts.append(current_part.strip())
                current_part = ""
            current_part += word + " "
        
        current_part += "\n"

    if current_part:
        parts.append(current_part.strip())

    for part in parts:
        if part != parts[-1]:
            client.send_message(destination_channel, part.strip() + " ...")
        else:
            client.send_message(destination_channel, part.strip())  # Ø¨Ø®Ø´ Ø¢Ø®Ø± Ø¨Ø¯ÙˆÙ† "..."
        time.sleep(2)  # ØªØ£Ø®ÛŒØ± 2 Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ Ø¨ÛŒÙ† Ù¾Ø§Ø±Øªâ€ŒÙ‡Ø§

# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú†Ù†Ø¯ÛŒÙ† Ø±Ø³Ø§Ù†Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ù¾ÛŒØ§Ù…
def send_media_with_message(client, destination_channel, message, message_text):
    media_files = []
    if isinstance(message.media, types.MessageMediaPhoto):
        media_files.append(message.media)
    elif isinstance(message.media, types.MessageMediaDocument) and message.file.mime_type.startswith("video"):
        media_files.append(message.media)
    elif message.grouped_id:
        media_group = client.get_messages(message.chat_id, grouped_id=message.grouped_id)
        for msg in media_group:
            if isinstance(msg.media, (types.MessageMediaPhoto, types.MessageMediaDocument)):
                media_files.append(msg.media)

    for media in media_files:
        client.send_message(destination_channel, file=media, message=message_text[:1024])
        time.sleep(2)  # ØªØ£Ø®ÛŒØ± Ø¨ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ù‡Ø± Ø±Ø³Ø§Ù†Ù‡

# Ø§ØªØµØ§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
with TelegramClient('session_name', api_id, api_hash) as client:
    client.connect()
    if not client.is_user_authorized():
        client.send_code_request(phone_number)
        client.sign_in(phone_number, input('Please enter the code sent to your Telegram: '))

    while True:  # Ø­Ù„Ù‚Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø®Ø¨Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ù‡Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡
        twelve_hours_ago = datetime.now(timezone.utc) - timedelta(hours=12)

        for source_channel in source_channels:
            messages = client.get_messages(source_channel, limit=100)

            for message in messages:
                if message.date >= twelve_hours_ago:
                    if message.message and not is_advertisement(message.message):
                        cleaned_message = clean_message_content(message.message)

                        if not is_duplicate(cleaned_message):
                            final_message = f"{cleaned_message}\n\nØ¨Ø±Ø§ÛŒ Ø§Ø®Ø¨Ø§Ø± Ø¨ÛŒØ´ØªØ±: {destination_link}"
                            
                            if message.media:
                                send_media_with_message(client, destination_channel, message, final_message)
                            else:
                                if len(final_message) > 1024:
                                    send_long_message(client, destination_channel, final_message)
                                else:
                                    client.send_message(destination_channel, final_message)

                            save_sent_message(cleaned_message)
                            print(f"Forwarded message from {source_channel}: {cleaned_message}")

                            time.sleep(2)  # ØªØ£Ø®ÛŒØ± 2 Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ Ø¨ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§

        print("All recent news sent successfully. Checking again in 15 minutes.")
        time.sleep(900)  # ØªØ£Ø®ÛŒØ± 15 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡
